<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAWLYN Limited - Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .logo-container {
            margin-bottom: 30px;
        }

        .logo-container img {
            max-width: 250px;
            height: auto;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .change-password-link {
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        .change-password-link:hover {
            color: #764ba2;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .container.active {
            display: block;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-width: 150px;
            height: auto;
        }

        .header-text h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-text p {
            color: #666;
            font-size: 1em;
        }

        .header-right {
            text-align: right;
        }

        .user-info {
            color: #666;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .location-filter {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .location-filter h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .location-filter select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: 600;
            color: #667eea;
        }

        .active-location-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .content.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="file"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            transition: border 0.3s;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-in-stock {
            background: #d4edda;
            color: #155724;
        }

        .status-low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .status-out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .download-template {
            background: #17a2b8;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .price-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .price-summary h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .price-row.total {
            border-top: 2px solid #667eea;
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
            font-size: 20px;
            color: #667eea;
        }

        .discount-input-group {
            display: flex;
            gap: 10px;
        }

        .discount-input-group input {
            flex: 1;
        }

        .discount-input-group select {
            flex: 0 0 100px;
        }

        .date-display {
            color: #666;
            font-size: 14px;
            font-style: italic;
        }

        /* Searchable Dropdown Styles */
        .searchable-select {
            position: relative;
        }

        .searchable-select .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 0;
        }

        .searchable-select .search-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .searchable-select .dropdown {
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .searchable-select .dropdown.active {
            display: block;
        }

        .searchable-select .dropdown-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .searchable-select .dropdown-item:hover {
            background: #f8f9fa;
        }

        .searchable-select .dropdown-item:last-child {
            border-bottom: none;
        }

        .searchable-select .dropdown-item.no-results {
            color: #999;
            cursor: default;
            text-align: center;
        }

        .searchable-select .dropdown-item.no-results:hover {
            background: white;
        }

        .selected-item-display {
            padding: 12px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
            margin-top: 8px;
            border-left: 4px solid #667eea;
        }

        .selected-item-display strong {
            color: #667eea;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .report-container, .report-container * {
                visibility: visible;
            }
            .report-container {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="logo-container">
            <img src="logo.jpg" alt="WAWLYN Logo">
        </div>
        <h2 style="color: #667eea; margin-bottom: 30px;">Inventory Management System</h2>
        <form class="login-form" onsubmit="login(event)">
            <input type="email" id="loginEmail" placeholder="üìß Email Address" required>
            <input type="password" id="loginPassword" placeholder="üîí Password" required>
            <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Login</button>
        </form>
        <div class="change-password-link" onclick="showChangePasswordModal()">üîë Change Password</div>
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
            Default credentials:<br>
            Email: admin@wawlyn.com<br>
            Password: admin123
        </p>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainApp">
        <div class="header">
            <div class="header-left">
                <img src="logo.jpg" alt="WAWLYN Logo" class="header-logo">
                <div class="header-text">
                    <h1>WAWLYN Limited</h1>
                    <p>Inventory Management System</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfo">üë§ Logged in as: admin@wawlyn.com</div>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Location Filter -->
        <div class="location-filter">
            <h3>
                üìç Active Location
                <span class="active-location-badge" id="activeLocationBadge">All Locations</span>
            </h3>
            <select id="activeLocationFilter" onchange="changeActiveLocation()">
                <option value="">All Locations</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="showTab('sales')">üí∞ Sales</button>
            <button class="tab" onclick="showTab('defective')">‚ö†Ô∏è Defective Items</button>
            <button class="tab" onclick="showTab('returns')">üîÑ Returns & Exchange</button>
            <button class="tab" onclick="showTab('transfer')">üìç Transfer</button>
            <button class="tab" onclick="showTab('reports')">üìà Reports</button>
            <button class="tab" onclick="showTab('import')">üì• Import Data</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="content active">
            <h2>Dashboard Overview</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Items</h3>
                    <div class="value" id="totalItems">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Stock</h3>
                    <div class="value" id="totalStock">0</div>
                </div>
                <div class="stat-card">
                    <h3>Low Stock Items</h3>
                    <div class="value" id="lowStockItems">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Value</h3>
                    <div class="value" id="totalValue">TZS 0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h3>Defective Items</h3>
                    <div class="value" id="defectiveCount">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <h3>Returns Today</h3>
                    <div class="value" id="returnsToday">0</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Recent Activities</h3>
            <div id="recentActivities" style="margin-top: 15px;">
                <p style="color: #666;">No recent activities</p>
            </div>
        </div>

        <!-- Inventory -->
        <div id="inventory" class="content">
            <h2>Inventory Management</h2>
            <button class="btn" onclick="showAddItemModal()">‚ûï Add New Item</button>
            <button class="btn btn-success" onclick="showAdjustPriceModal()">üíµ Adjust Prices</button>
            
            <input type="text" class="search-box" id="searchInventory" placeholder="üîç Search by name, variant, or location..." onkeyup="searchInventory()">

            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Min Stock</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Price</th>
                        <th>Added Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">No items in inventory</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Sales -->
        <div id="sales" class="content">
            <h2>Record Sales</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Item</label>
                    <div class="searchable-select">
                        <input type="text" 
                               id="saleItemSearch" 
                               class="search-input" 
                               placeholder="üîç Type to search item..." 
                               onfocus="showSaleDropdown()" 
                               oninput="filterSaleItems()">
                        <div id="saleDropdown" class="dropdown">
                            <div class="dropdown-item no-results">Start typing to search...</div>
                        </div>
                        <input type="hidden" id="saleItem">
                    </div>
                    <div id="selectedItemDisplay" class="selected-item-display" style="display: none;">
                        <strong>‚úì Selected:</strong> <span id="selectedItemText"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity Sold</label>
                    <input type="number" id="saleQuantity" min="1" placeholder="Enter quantity" onchange="calculateSaleTotal()">
                </div>
                <div class="form-group">
                    <label>Transaction Date</label>
                    <input type="date" id="saleDate">
                </div>
            </div>

            <div class="form-group">
                <label>Discount (Optional)</label>
                <div class="discount-input-group">
                    <input type="number" id="discountValue" min="0" placeholder="Enter discount amount" onchange="calculateSaleTotal()">
                    <select id="discountType" onchange="calculateSaleTotal()">
                        <option value="percent">%</option>
                        <option value="fixed">TZS</option>
                    </select>
                </div>
            </div>

            <div class="price-summary" id="salePriceSummary" style="display: none;">
                <h4>üí∞ Sale Summary</h4>
                <div class="price-row">
                    <span>Item:</span>
                    <span id="summaryItem">-</span>
                </div>
                <div class="price-row">
                    <span>Quantity:</span>
                    <span id="summaryQuantity">-</span>
                </div>
                <div class="price-row">
                    <span>Unit Price:</span>
                    <span id="summaryUnitPrice">TZS 0</span>
                </div>
                <div class="price-row">
                    <span>Subtotal:</span>
                    <span id="summarySubtotal">TZS 0</span>
                </div>
                <div class="price-row" id="discountRow" style="display: none; color: #28a745;">
                    <span>Discount:</span>
                    <span id="summaryDiscount">TZS 0</span>
                </div>
                <div class="price-row total">
                    <span>Total:</span>
                    <span id="summaryTotal">TZS 0</span>
                </div>
            </div>

            <button class="btn btn-success" onclick="recordSale()" style="margin-top: 15px;">‚úÖ Record Sale</button>

            <h3 style="margin-top: 30px;">Sales History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Discount</th>
                        <th>Location</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">No sales recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Defective Items -->
        <div id="defective" class="content">
            <h2>‚ö†Ô∏è Defective Items</h2>
            <p style="color: #666; margin-bottom: 20px;">Record items that are defective or damaged. These will be deducted from inventory.</p>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="defectiveItem">
                        <option value="">Choose item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity Defective</label>
                    <input type="number" id="defectiveQuantity" min="1" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="defectiveDate">
                </div>
            </div>

            <div class="form-group">
                <label>Reason / Notes</label>
                <textarea id="defectiveReason" placeholder="Describe the defect or damage..."></textarea>
            </div>

            <button class="btn btn-danger" onclick="recordDefective()">‚ö†Ô∏è Record Defective Item</button>

            <h3 style="margin-top: 30px;">Defective Items History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Location</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="defectiveBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">No defective items recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Returns & Exchange -->
        <div id="returns" class="content">
            <h2>üîÑ Returns & Exchange</h2>
            <p style="color: #666; margin-bottom: 20px;">Process customer returns and exchanges. Returns add back to stock, exchanges swap items.</p>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">Transaction Type:</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="returnType" value="return" checked onchange="toggleExchangeFields()">
                        Return Only (Add back to stock)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="returnType" value="exchange" onchange="toggleExchangeFields()">
                        Exchange (Return & Replace)
                    </label>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Returned Item</label>
                    <select id="returnItem">
                        <option value="">Choose item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity Returned</label>
                    <input type="number" id="returnQuantity" min="1" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="returnDate">
                </div>
            </div>

            <div id="exchangeSection" style="display: none;">
                <h3 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">Exchange With:</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Replacement Item</label>
                        <select id="exchangeItem">
                            <option value="">Choose item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exchange Quantity</label>
                        <input type="number" id="exchangeQuantity" min="1" placeholder="Enter quantity">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Reason / Notes</label>
                <textarea id="returnReason" placeholder="Reason for return/exchange..."></textarea>
            </div>

            <button class="btn btn-info" onclick="recordReturn()">üîÑ Process Return/Exchange</button>

            <h3 style="margin-top: 30px;">Returns & Exchange History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Returned Item</th>
                        <th>Qty</th>
                        <th>Exchange Item</th>
                        <th>Qty</th>
                        <th>Location</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="returnsBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">No returns recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Transfer -->
        <div id="transfer" class="content">
            <h2>Transfer Items</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="transferItem">
                        <option value="">Choose item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="transferQuantity" min="1" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label>From Location</label>
                    <select id="transferFrom">
                        <option value="">Choose location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>To Location</label>
                    <select id="transferTo">
                        <option value="">Choose location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transfer Date</label>
                    <input type="date" id="transferDate">
                </div>
            </div>
            <button class="btn btn-warning" onclick="transferItems()">üîÑ Transfer Items</button>

            <h3 style="margin-top: 30px;">Transfer History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transferBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">No transfers recorded</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Reports -->
        <div id="reports" class="content">
            <h2>Reports</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Report Date</label>
                    <input type="date" id="reportDate">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Generate Reports</h3>
                <button class="btn btn-success" onclick="generateEODReport()">üìÑ Generate End of Day Report</button>
                <button class="btn" onclick="generateInventoryReport()">üìã Full Inventory Report</button>
                <button class="btn btn-warning" onclick="generateSalesReport()">üí∞ Sales Report</button>
            </div>

            <div id="exportButtons" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">Export Report</h3>
                <button class="btn btn-success" onclick="exportCurrentReport('pdf')" style="background: #dc3545;">üì• Export as PDF</button>
                <button class="btn" onclick="exportCurrentReport('excel')">üìä Export as Excel</button>
                <button class="btn btn-secondary" onclick="exportCurrentReport('csv')">üìã Export as CSV</button>
            </div>
            
            <div id="reportContainer" class="report-container" style="margin-top: 30px;"></div>
        </div>

        <!-- Import Data -->
        <div id="import" class="content">
            <h2>Import Inventory Data</h2>
            
            <div class="download-template">
                <h3 style="margin-bottom: 10px;">üì• Download CSV Template</h3>
                <p style="margin-bottom: 15px;">Download the template file and fill it with your inventory data</p>
                <button class="btn" onclick="downloadTemplate()">Download Template</button>
            </div>

            <div class="form-group">
                <label>Upload CSV File</label>
                <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
            </div>

            <p style="color: #666; margin-top: 10px; margin-bottom: 20px;">
                <strong>Format:</strong> Name, Variant, Quantity, Min Stock, Status, Location, Price<br>
                <strong>Example:</strong> iPhone 14 Pro, 128GB Black, 10, 5, In Stock, Main Store, 45000
            </p>

            <div style="border-top: 2px solid #ddd; padding-top: 20px; margin-top: 30px;">
                <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Data Management</h3>
                <button class="btn btn-success" onclick="exportData()">üì§ Export All Data (Backup)</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">
                    <strong>Export:</strong> Download all your inventory, sales, and transfer data as JSON backup<br>
                    <strong>Clear All:</strong> Delete all records from the system (use with caution!)
                </p>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üîë Change Password</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="changeEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <button class="btn btn-success" onclick="changePassword()">‚úÖ Change Password</button>
            <button class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Cancel</button>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addItemModal')">&times;</span>
            <h2>Add New Item</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="itemName" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label>Variant</label>
                <input type="text" id="itemVariant" placeholder="Enter variant (e.g., 128GB Black)">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="itemQuantity" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label>Min Stock</label>
                <input type="number" id="itemMinStock" min="0" placeholder="Minimum stock level">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="itemLocation" placeholder="Store location">
            </div>
            <div class="form-group">
                <label>Price (TZS)</label>
                <input type="number" id="itemPrice" min="0" step="0.01" placeholder="Enter price">
            </div>
            <button class="btn btn-success" onclick="addItem()">Add Item</button>
            <button class="btn btn-secondary" onclick="closeModal('addItemModal')">Cancel</button>
        </div>
    </div>

    <!-- Adjust Price Modal -->
    <div id="adjustPriceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adjustPriceModal')">&times;</span>
            <h2>Adjust Prices</h2>
            <div class="form-group">
                <label>Select Item</label>
                <select id="priceAdjustItem">
                    <option value="">Choose item...</option>
                </select>
            </div>
            <div class="form-group">
                <label>New Price (TZS)</label>
                <input type="number" id="newPrice" min="0" step="0.01" placeholder="Enter new price">
            </div>
            <button class="btn btn-success" onclick="adjustPrice()">Update Price</button>
            <button class="btn btn-secondary" onclick="closeModal('adjustPriceModal')">Cancel</button>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editItemModal')">&times;</span>
            <h2>Edit Item</h2>
            <input type="hidden" id="editItemId">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="editItemName" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label>Variant</label>
                <input type="text" id="editItemVariant" placeholder="Enter variant">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="editItemQuantity" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label>Min Stock</label>
                <input type="number" id="editItemMinStock" min="0" placeholder="Minimum stock level">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="editItemLocation" placeholder="Store location">
            </div>
            <div class="form-group">
                <label>Price (TZS)</label>
                <input type="number" id="editItemPrice" min="0" step="0.01" placeholder="Enter price">
            </div>
            <button class="btn btn-success" onclick="updateItem()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editItemModal')">Cancel</button>
        </div>
    </div>

    <script>
        // Data storage
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let transfers = JSON.parse(localStorage.getItem('transfers')) || [];
        let defectiveItems = JSON.parse(localStorage.getItem('defectiveItems')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let activities = JSON.parse(localStorage.getItem('activities')) || [];
        let currentUser = null;
        let activeLocation = localStorage.getItem('activeLocation') || '';
        
        // User credentials storage
        let userCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
            'admin@wawlyn.com': 'admin123'
        };
        
        // Report tracking for export
        let currentReportType = null;
        let currentReportData = null;

        // Searchable dropdown data
        let saleItemsData = [];

        // Initialize
        window.onload = function() {
            checkLogin();
            setDefaultDate();
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const searchableSelect = document.querySelector('.searchable-select');
                if (searchableSelect && !searchableSelect.contains(e.target)) {
                    document.getElementById('saleDropdown').classList.remove('active');
                }
            });
        };

        function checkLogin() {
            currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
                document.getElementById('userInfo').textContent = 'üë§ Logged in as: ' + currentUser;
                updateLocationFilter();
                updateDashboard();
                renderInventory();
                renderSales();
                renderTransfers();
                renderDefective();
                renderReturns();
                updateSelects();
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').classList.remove('active');
            }
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (userCredentials[email] && userCredentials[email] === password) {
                localStorage.setItem('currentUser', email);
                currentUser = email;
                
                activities.push({ text: `User logged in: ${email}`, date: new Date().toISOString() });
                if (activities.length > 100) activities = activities.slice(-100);
                localStorage.setItem('activities', JSON.stringify(activities));
                
                checkLogin();
            } else {
                alert('Invalid email or password!');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                addActivity(`User logged out: ${currentUser}`);
                localStorage.removeItem('currentUser');
                currentUser = null;
                checkLogin();
            }
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        function changePassword() {
            const email = document.getElementById('changeEmail').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!email || !currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill all fields');
                return;
            }

            if (!userCredentials[email]) {
                alert('Email not found in system');
                return;
            }

            if (userCredentials[email] !== currentPassword) {
                alert('Current password is incorrect');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword === currentPassword) {
                alert('New password must be different from current password');
                return;
            }

            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }

            userCredentials[email] = newPassword;
            localStorage.setItem('userCredentials', JSON.stringify(userCredentials));

            document.getElementById('changeEmail').value = '';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            closeModal('changePasswordModal');
            alert('Password changed successfully! Please login with your new password.');

            if (currentUser === email) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                checkLogin();
            }
        }

        function updateLocationFilter() {
            const filter = document.getElementById('activeLocationFilter');
            const locations = [...new Set(inventory.map(i => i.location))];
            const predefinedLocations = ['Main Store', 'Branch 1', 'Kariakoo', 'Warehouse'];
            const allLocations = [...new Set([...predefinedLocations, ...locations])];
            
            filter.innerHTML = '<option value="">All Locations</option>' + 
                allLocations.map(loc => `<option value="${loc}" ${loc === activeLocation ? 'selected' : ''}>${loc}</option>`).join('');
            
            updateActiveLocationBadge();
        }

        function changeActiveLocation() {
            activeLocation = document.getElementById('activeLocationFilter').value;
            localStorage.setItem('activeLocation', activeLocation);
            updateActiveLocationBadge();
            updateDashboard();
            renderInventory();
            renderSales();
            renderTransfers();
            renderDefective();
            renderReturns();
            updateSelects();
        }

        function updateActiveLocationBadge() {
            const badge = document.getElementById('activeLocationBadge');
            badge.textContent = activeLocation || 'All Locations';
        }

        function getFilteredInventory() {
            if (!activeLocation) return inventory;
            return inventory.filter(item => item.location === activeLocation);
        }

        function getFilteredSales() {
            if (!activeLocation) return sales;
            return sales.filter(sale => sale.location === activeLocation);
        }

        function getFilteredTransfers() {
            if (!activeLocation) return transfers;
            return transfers.filter(t => t.from === activeLocation || t.to === activeLocation);
        }

        function getFilteredDefective() {
            if (!activeLocation) return defectiveItems;
            return defectiveItems.filter(d => d.location === activeLocation);
        }

        function getFilteredReturns() {
            if (!activeLocation) return returns;
            return returns.filter(r => r.location === activeLocation);
        }

        function setDefaultDate() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            
            const dateFields = ['saleDate', 'transferDate', 'reportDate', 'defectiveDate', 'returnDate'];
            dateFields.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.value = dateStr;
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (['sales', 'transfer', 'reports', 'defective', 'returns'].includes(tabName)) {
                setDefaultDate();
            }
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').style.display = 'block';
        }

        function showAdjustPriceModal() {
            document.getElementById('adjustPriceModal').style.display = 'block';
            updatePriceAdjustSelect();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function addItem() {
            const item = {
                id: Date.now(),
                name: document.getElementById('itemName').value,
                variant: document.getElementById('itemVariant').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                minStock: parseInt(document.getElementById('itemMinStock').value),
                location: document.getElementById('itemLocation').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                dateAdded: new Date().toISOString()
            };

            if (!item.name || !item.variant || !item.location) {
                alert('Please fill all required fields');
                return;
            }

            inventory.push(item);
            saveData();
            addActivity(`Added new item: ${item.name} - ${item.variant} at ${item.location}`);
            renderInventory();
            updateDashboard();
            updateSelects();
            updateLocationFilter();
            closeModal('addItemModal');
            clearForm();
            alert('Item added successfully!');
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemVariant').value = '';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemMinStock').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemPrice').value = '';
        }

        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                const item = inventory.find(i => i.id === id);
                inventory = inventory.filter(i => i.id !== id);
                saveData();
                addActivity(`Deleted item: ${item.name} - ${item.variant}`);
                renderInventory();
                updateDashboard();
                updateSelects();
                updateLocationFilter();
            }
        }

        function getStatus(item) {
            if (item.quantity === 0) return 'Out of Stock';
            if (item.quantity <= item.minStock) return 'Low Stock';
            return 'In Stock';
        }

        function getStatusClass(status) {
            if (status === 'In Stock') return 'status-in-stock';
            if (status === 'Low Stock') return 'status-low-stock';
            return 'status-out-of-stock';
        }

        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            const filtered = getFilteredInventory();
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No items in inventory</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const status = getStatus(item);
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.variant}</td>
                        <td>${item.quantity}</td>
                        <td>${item.minStock}</td>
                        <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                        <td>${item.location}</td>
                        <td>TZS ${item.price.toLocaleString()}</td>
                        <td class="date-display">${formatDate(item.dateAdded)}</td>
                        <td>
                            <button class="action-btn btn-warning" onclick="editItem(${item.id})" style="background: #ffc107; color: #000;">‚úèÔ∏è Edit</button>
                            <button class="action-btn btn-danger" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchInventory() {
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const filtered = getFilteredInventory().filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.variant.toLowerCase().includes(searchTerm) ||
                item.location.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('inventoryBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No matching items found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const status = getStatus(item);
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.variant}</td>
                        <td>${item.quantity}</td>
                        <td>${item.minStock}</td>
                        <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                        <td>${item.location}</td>
                        <td>TZS ${item.price.toLocaleString()}</td>
                        <td class="date-display">${formatDate(item.dateAdded)}</td>
                        <td>
                            <button class="action-btn btn-warning" onclick="editItem(${item.id})" style="background: #ffc107; color: #000;">‚úèÔ∏è Edit</button>
                            <button class="action-btn btn-danger" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // SEARCHABLE DROPDOWN FUNCTIONS FOR SALES
        function showSaleDropdown() {
            const dropdown = document.getElementById('saleDropdown');
            dropdown.classList.add('active');
            filterSaleItems();
        }

        function filterSaleItems() {
            const searchInput = document.getElementById('saleItemSearch');
            const searchTerm = searchInput.value.toLowerCase();
            const dropdown = document.getElementById('saleDropdown');
            
            saleItemsData = getFilteredInventory();
            
            if (searchTerm === '') {
                dropdown.innerHTML = saleItemsData.map(item => `
                    <div class="dropdown-item" onclick="selectSaleItem(${item.id})">
                        ${item.name} - ${item.variant} (${item.location}) - Stock: ${item.quantity}
                    </div>
                `).join('');
                
                if (saleItemsData.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item no-results">No items available</div>';
                }
            } else {
                const filtered = saleItemsData.filter(item => {
                    const searchableText = `${item.name} ${item.variant} ${item.location}`.toLowerCase();
                    return searchableText.includes(searchTerm);
                });
                
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item no-results">No matching items found</div>';
                } else {
                    dropdown.innerHTML = filtered.map(item => `
                        <div class="dropdown-item" onclick="selectSaleItem(${item.id})">
                            ${item.name} - ${item.variant} (${item.location}) - Stock: ${item.quantity}
                        </div>
                    `).join('');
                }
            }
            
            dropdown.classList.add('active');
        }

        function selectSaleItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            document.getElementById('saleItem').value = itemId;
            document.getElementById('saleItemSearch').value = `${item.name} - ${item.variant} (${item.location})`;
            document.getElementById('selectedItemDisplay').style.display = 'block';
            document.getElementById('selectedItemText').textContent = 
                `${item.name} - ${item.variant} (${item.location}) - Stock: ${item.quantity} - Price: TZS ${item.price.toLocaleString()}`;
            
            document.getElementById('saleDropdown').classList.remove('active');
            
            calculateSaleTotal();
        }

        function calculateSaleTotal() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;

            if (!itemId || !quantity) {
                document.getElementById('salePriceSummary').style.display = 'none';
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            const subtotal = item.price * quantity;
            let discountAmount = 0;

            if (discountValue > 0) {
                if (discountType === 'percent') {
                    discountAmount = subtotal * (discountValue / 100);
                } else {
                    discountAmount = discountValue;
                }
            }

            const total = subtotal - discountAmount;

            document.getElementById('summaryItem').textContent = `${item.name} - ${item.variant}`;
            document.getElementById('summaryQuantity').textContent = quantity;
            document.getElementById('summaryUnitPrice').textContent = `TZS ${item.price.toLocaleString()}`;
            document.getElementById('summarySubtotal').textContent = `TZS ${subtotal.toLocaleString()}`;
            
            if (discountAmount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                const discountText = discountType === 'percent' 
                    ? `-TZS ${discountAmount.toLocaleString()} (${discountValue}%)`
                    : `-TZS ${discountAmount.toLocaleString()}`;
                document.getElementById('summaryDiscount').textContent = discountText;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('summaryTotal').textContent = `TZS ${total.toLocaleString()}`;
            document.getElementById('salePriceSummary').style.display = 'block';
        }

        function recordSale() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const saleDate = document.getElementById('saleDate').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;

            if (!itemId || !quantity || !saleDate) {
                alert('Please fill all required fields');
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }

            if (item.quantity < quantity) {
                alert(`Insufficient stock! Only ${item.quantity} available`);
                return;
            }

            item.quantity -= quantity;
            
            const subtotal = item.price * quantity;
            let discountAmount = 0;

            if (discountValue > 0) {
                if (discountType === 'percent') {
                    discountAmount = subtotal * (discountValue / 100);
                } else {
                    discountAmount = discountValue;
                }
            }

            const sale = {
                id: Date.now(),
                itemId: item.id,
                name: item.name,
                variant: item.variant,
                quantity: quantity,
                price: item.price,
                location: item.location,
                discountAmount: discountAmount,
                discountType: discountType,
                discountValue: discountValue,
                subtotal: subtotal,
                total: subtotal - discountAmount,
                date: new Date(saleDate).toISOString()
            };

            sales.push(sale);
            saveData();
            
            const discountText = discountAmount > 0 
                ? ` (Discount: ${discountType === 'percent' ? discountValue + '%' : 'TZS ' + discountAmount})`
                : '';
            addActivity(`Sale recorded: ${quantity}x ${item.name} - ${item.variant} at ${item.location}${discountText}`);
            
            renderSales();
            renderInventory();
            updateDashboard();
            updateSelects();
            
            // Clear form
            document.getElementById('saleItemSearch').value = '';
            document.getElementById('saleItem').value = '';
            document.getElementById('saleQuantity').value = '';
            document.getElementById('discountValue').value = '';
            document.getElementById('selectedItemDisplay').style.display = 'none';
            document.getElementById('salePriceSummary').style.display = 'none';
            setDefaultDate();
            
            alert('Sale recorded successfully!');
        }

        function renderSales() {
            const tbody = document.getElementById('salesBody');
            const filtered = getFilteredSales();

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No sales recorded</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.slice(-50).reverse().map(sale => {
                const discountText = sale.discountAmount > 0 
                    ? (sale.discountType === 'percent' 
                        ? `${sale.discountValue}% (TZS ${sale.discountAmount.toLocaleString()})`
                        : `TZS ${sale.discountAmount.toLocaleString()}`)
                    : '-';

                return `
                    <tr>
                        <td class="date-display">${formatDate(sale.date)}</td>
                        <td>${sale.name}</td>
                        <td>${sale.variant}</td>
                        <td>${sale.quantity}</td>
                        <td>TZS ${sale.price.toLocaleString()}</td>
                        <td style="color: ${sale.discountAmount > 0 ? '#28a745' : '#666'};">${discountText}</td>
                        <td>${sale.location}</td>
                        <td><strong>TZS ${sale.total.toLocaleString()}</strong></td>
                        <td>
                            <button class="action-btn btn-danger" onclick="deleteSale(${sale.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteSale(id) {
            if (confirm('Delete this sale record? This will restore the stock quantity.')) {
                const sale = sales.find(s => s.id === id);
                if (sale) {
                    const item = inventory.find(i => i.id === sale.itemId && i.location === sale.location);
                    if (item) {
                        item.quantity += sale.quantity;
                    }
                    
                    sales = sales.filter(s => s.id !== id);
                    saveData();
                    addActivity(`Deleted sale: ${sale.quantity}x ${sale.name} - ${sale.variant}`);
                    renderSales();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        // DEFECTIVE ITEMS FUNCTIONS
        function recordDefective() {
            const itemId = parseInt(document.getElementById('defectiveItem').value);
            const quantity = parseInt(document.getElementById('defectiveQuantity').value);
            const defectiveDate = document.getElementById('defectiveDate').value;
            const reason = document.getElementById('defectiveReason').value;

            if (!itemId || !quantity || !defectiveDate || !reason) {
                alert('Please fill all required fields');
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }

            if (item.quantity < quantity) {
                alert(`Insufficient stock! Only ${item.quantity} available`);
                return;
            }

            item.quantity -= quantity;

            const defective = {
                id: Date.now(),
                itemId: item.id,
                name: item.name,
                variant: item.variant,
                quantity: quantity,
                location: item.location,
                reason: reason,
                date: new Date(defectiveDate).toISOString()
            };

            defectiveItems.push(defective);
            saveData();
            addActivity(`Defective recorded: ${quantity}x ${item.name} - ${item.variant} at ${item.location}`);
            
            renderDefective();
            renderInventory();
            updateDashboard();
            
            document.getElementById('defectiveQuantity').value = '';
            document.getElementById('defectiveReason').value = '';
            setDefaultDate();
            
            alert('Defective item recorded successfully!');
        }

        function renderDefective() {
            const tbody = document.getElementById('defectiveBody');
            const filtered = getFilteredDefective();

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No defective items recorded</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.slice(-50).reverse().map(defective => `
                <tr>
                    <td class="date-display">${formatDate(defective.date)}</td>
                    <td>${defective.name}</td>
                    <td>${defective.variant}</td>
                    <td>${defective.quantity}</td>
                    <td>${defective.location}</td>
                    <td>${defective.reason}</td>
                    <td>
                        <button class="action-btn btn-danger" onclick="deleteDefective(${defective.id})">üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteDefective(id) {
            if (confirm('Delete this defective record? This will restore the stock quantity.')) {
                const defective = defectiveItems.find(d => d.id === id);
                if (defective) {
                    const item = inventory.find(i => i.id === defective.itemId && i.location === defective.location);
                    if (item) {
                        item.quantity += defective.quantity;
                    }
                    
                    defectiveItems = defectiveItems.filter(d => d.id !== id);
                    saveData();
                    addActivity(`Deleted defective: ${defective.quantity}x ${defective.name} - ${defective.variant}`);
                    renderDefective();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        // RETURNS & EXCHANGE FUNCTIONS
        function toggleExchangeFields() {
            const returnType = document.querySelector('input[name="returnType"]:checked').value;
            const exchangeSection = document.getElementById('exchangeSection');
            exchangeSection.style.display = returnType === 'exchange' ? 'block' : 'none';
        }

        function recordReturn() {
            const returnType = document.querySelector('input[name="returnType"]:checked').value;
            const itemId = parseInt(document.getElementById('returnItem').value);
            const quantity = parseInt(document.getElementById('returnQuantity').value);
            const returnDate = document.getElementById('returnDate').value;
            const reason = document.getElementById('returnReason').value;

            if (!itemId || !quantity || !returnDate || !reason) {
                alert('Please fill all required fields');
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }

            item.quantity += quantity;

            let exchangeItemData = null;
            let exchangeQty = 0;

            if (returnType === 'exchange') {
                const exchangeItemId = parseInt(document.getElementById('exchangeItem').value);
                exchangeQty = parseInt(document.getElementById('exchangeQuantity').value);

                if (!exchangeItemId || !exchangeQty) {
                    alert('Please fill all exchange fields');
                    return;
                }

                const exchangeItem = inventory.find(i => i.id === exchangeItemId);
                if (!exchangeItem) {
                    alert('Exchange item not found');
                    return;
                }

                if (exchangeItem.quantity < exchangeQty) {
                    alert(`Insufficient stock for exchange! Only ${exchangeItem.quantity} available`);
                    return;
                }

                exchangeItem.quantity -= exchangeQty;
                exchangeItemData = {
                    id: exchangeItem.id,
                    name: exchangeItem.name,
                    variant: exchangeItem.variant
                };
            }

            const returnRecord = {
                id: Date.now(),
                type: returnType,
                returnedItemId: item.id,
                returnedItemName: item.name,
                returnedItemVariant: item.variant,
                returnedQuantity: quantity,
                exchangeItem: exchangeItemData,
                exchangeQuantity: exchangeQty,
                location: item.location,
                reason: reason,
                date: new Date(returnDate).toISOString()
            };

            returns.push(returnRecord);
            saveData();
            
            const activityText = returnType === 'exchange' 
                ? `Exchange: ${quantity}x ${item.name} for ${exchangeQty}x ${exchangeItemData.name} at ${item.location}`
                : `Return: ${quantity}x ${item.name} - ${item.variant} at ${item.location}`;
            addActivity(activityText);
            
            renderReturns();
            renderInventory();
            updateDashboard();
            
            document.getElementById('returnQuantity').value = '';
            document.getElementById('exchangeQuantity').value = '';
            document.getElementById('returnReason').value = '';
            setDefaultDate();
            
            alert(returnType === 'exchange' ? 'Exchange processed successfully!' : 'Return processed successfully!');
        }

        function renderReturns() {
            const tbody = document.getElementById('returnsBody');
            const filtered = getFilteredReturns();

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No returns recorded</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.slice(-50).reverse().map(ret => {
                const exchangeText = ret.type === 'exchange' && ret.exchangeItem
                    ? `${ret.exchangeItem.name} - ${ret.exchangeItem.variant}`
                    : '-';
                const exchangeQtyText = ret.type === 'exchange' ? ret.exchangeQuantity : '-';

                return `
                    <tr>
                        <td class="date-display">${formatDate(ret.date)}</td>
                        <td><span class="status-badge ${ret.type === 'exchange' ? 'status-low-stock' : 'status-in-stock'}">${ret.type.toUpperCase()}</span></td>
                        <td>${ret.returnedItemName} - ${ret.returnedItemVariant}</td>
                        <td>${ret.returnedQuantity}</td>
                        <td>${exchangeText}</td>
                        <td>${exchangeQtyText}</td>
                        <td>${ret.location}</td>
                        <td>${ret.reason}</td>
                        <td>
                            <button class="action-btn btn-danger" onclick="deleteReturn(${ret.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteReturn(id) {
            if (confirm('Delete this return/exchange record? This will reverse the transaction.')) {
                const ret = returns.find(r => r.id === id);
                if (ret) {
                    const returnedItem = inventory.find(i => i.id === ret.returnedItemId && i.location === ret.location);
                    if (returnedItem) {
                        returnedItem.quantity -= ret.returnedQuantity;
                    }

                    if (ret.type === 'exchange' && ret.exchangeItem) {
                        const exchangedItem = inventory.find(i => i.id === ret.exchangeItem.id && i.location === ret.location);
                        if (exchangedItem) {
                            exchangedItem.quantity += ret.exchangeQuantity;
                        }
                    }
                    
                    returns = returns.filter(r => r.id !== id);
                    saveData();
                    addActivity(`Deleted return/exchange: ${ret.returnedItemName}`);
                    renderReturns();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        function transferItems() {
            const itemId = parseInt(document.getElementById('transferItem').value);
            const quantity = parseInt(document.getElementById('transferQuantity').value);
            const fromLocation = document.getElementById('transferFrom').value;
            const toLocation = document.getElementById('transferTo').value;
            const transferDate = document.getElementById('transferDate').value;

            if (!itemId || !quantity || !fromLocation || !toLocation || !transferDate) {
                alert('Please fill all fields');
                return;
            }

            if (fromLocation === toLocation) {
                alert('Cannot transfer to same location');
                return;
            }

            const fromItem = inventory.find(i => i.id === itemId && i.location === fromLocation);
            if (!fromItem || fromItem.quantity < quantity) {
                alert('Insufficient stock in source location');
                return;
            }

            fromItem.quantity -= quantity;

            let toItem = inventory.find(i => i.id === itemId && i.location === toLocation);
            if (toItem) {
                toItem.quantity += quantity;
            } else {
                toItem = {...fromItem, id: Date.now(), location: toLocation, quantity: quantity, dateAdded: new Date().toISOString()};
                inventory.push(toItem);
            }

            const transfer = {
                id: Date.now(),
                itemId: itemId,
                name: fromItem.name,
                variant: fromItem.variant,
                quantity: quantity,
                from: fromLocation,
                to: toLocation,
                date: new Date(transferDate).toISOString()
            };

            transfers.push(transfer);
            saveData();
            addActivity(`Transfer: ${quantity}x ${fromItem.name} from ${fromLocation} to ${toLocation}`);
            renderTransfers();
            renderInventory();
            updateDashboard();
            
            document.getElementById('transferQuantity').value = '';
            setDefaultDate();
            alert('Transfer completed successfully!');
        }

        function renderTransfers() {
            const tbody = document.getElementById('transferBody');
            const filtered = getFilteredTransfers();
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No transfers recorded</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.slice(-50).reverse().map(transfer => `
                <tr>
                    <td class="date-display">${formatDate(transfer.date)}</td>
                    <td>${transfer.name}</td>
                    <td>${transfer.variant}</td>
                    <td>${transfer.quantity}</td>
                    <td>${transfer.from}</td>
                    <td>${transfer.to}</td>
                    <td>
                        <button class="action-btn btn-danger" onclick="deleteTransfer(${transfer.id})">üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteTransfer(id) {
            if (confirm('Delete this transfer record? This will reverse the transfer.')) {
                const transfer = transfers.find(t => t.id === id);
                if (transfer) {
                    const fromItem = inventory.find(i => i.name === transfer.name && i.variant === transfer.variant && i.location === transfer.from);
                    const toItem = inventory.find(i => i.name === transfer.name && i.variant === transfer.variant && i.location === transfer.to);
                    
                    if (fromItem) fromItem.quantity += transfer.quantity;
                    if (toItem) toItem.quantity -= transfer.quantity;
                    
                    transfers = transfers.filter(t => t.id !== id);
                    saveData();
                    addActivity(`Deleted transfer: ${transfer.quantity}x ${transfer.name} from ${transfer.from} to ${transfer.to}`);
                    renderTransfers();
                    renderInventory();
                    updateDashboard();
                }
            }
        }

        function updateSelects() {
            const transferItemSelect = document.getElementById('transferItem');
            const defectiveItemSelect = document.getElementById('defectiveItem');
            const returnItemSelect = document.getElementById('returnItem');
            const exchangeItemSelect = document.getElementById('exchangeItem');
            
            const filteredInventory = getFilteredInventory();
            
            const itemOptions = filteredInventory.map(item => 
                `<option value="${item.id}">${item.name} - ${item.variant} (${item.location}) - Stock: ${item.quantity}</option>`
            ).join('');

            defectiveItemSelect.innerHTML = '<option value="">Choose item...</option>' + itemOptions;
            returnItemSelect.innerHTML = '<option value="">Choose item...</option>' + itemOptions;
            exchangeItemSelect.innerHTML = '<option value="">Choose item...</option>' + itemOptions;
            
            const transferFilteredInventory = activeLocation 
                ? inventory.filter(i => i.location === activeLocation)
                : inventory;
            
            const uniqueTransferItems = [...new Set(transferFilteredInventory.map(i => JSON.stringify({id: i.id, name: i.name, variant: i.variant})))]
                .map(s => JSON.parse(s));
            
            transferItemSelect.innerHTML = '<option value="">Choose item...</option>' + 
                uniqueTransferItems.map(item => `<option value="${item.id}">${item.name} - ${item.variant}</option>`).join('');

            const locations = [...new Set(inventory.map(i => i.location))];
            const predefinedLocations = ['Main Store', 'Branch 1', 'Kariakoo', 'Warehouse'];
            const allLocations = [...new Set([...predefinedLocations, ...locations])];
            const locationOptions = allLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            
            document.getElementById('transferFrom').innerHTML = '<option value="">Choose location...</option>' + locationOptions;
            document.getElementById('transferTo').innerHTML = '<option value="">Choose location...</option>' + locationOptions;

            // Update sale items data for searchable dropdown
            saleItemsData = filteredInventory;
        }

        function updatePriceAdjustSelect() {
            const select = document.getElementById('priceAdjustItem');
            const filtered = getFilteredInventory();
            const options = filtered.map(item => 
                `<option value="${item.id}">${item.name} - ${item.variant} (Current: TZS ${item.price})</option>`
            ).join('');
            select.innerHTML = '<option value="">Choose item...</option>' + options;
        }

        function adjustPrice() {
            const itemId = parseInt(document.getElementById('priceAdjustItem').value);
            const newPrice = parseFloat(document.getElementById('newPrice').value);

            if (!itemId || !newPrice) {
                alert('Please select item and enter new price');
                return;
            }

            inventory.forEach(item => {
                if (item.id === itemId) {
                    const oldPrice = item.price;
                    item.price = newPrice;
                    addActivity(`Price adjusted for ${item.name} - ${item.variant}: TZS ${oldPrice} ‚Üí TZS ${newPrice}`);
                }
            });

            saveData();
            renderInventory();
            closeModal('adjustPriceModal');
            alert('Price updated successfully!');
        }

        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemVariant').value = item.variant;
            document.getElementById('editItemQuantity').value = item.quantity;
            document.getElementById('editItemMinStock').value = item.minStock;
            document.getElementById('editItemLocation').value = item.location;
            document.getElementById('editItemPrice').value = item.price;

            document.getElementById('editItemModal').style.display = 'block';
        }

        function updateItem() {
            const id = parseInt(document.getElementById('editItemId').value);
            const item = inventory.find(i => i.id === id);
            
            if (!item) return;

            const oldData = `${item.name} - ${item.variant}`;
            
            item.name = document.getElementById('editItemName').value;
            item.variant = document.getElementById('editItemVariant').value;
            item.quantity = parseInt(document.getElementById('editItemQuantity').value);
            item.minStock = parseInt(document.getElementById('editItemMinStock').value);
            item.location = document.getElementById('editItemLocation').value;
            item.price = parseFloat(document.getElementById('editItemPrice').value);

            if (!item.name || !item.variant || !item.location) {
                alert('Please fill all required fields');
                return;
            }

            saveData();
            addActivity(`Updated item: ${oldData} ‚Üí ${item.name} - ${item.variant}`);
            renderInventory();
            updateLocationFilter();
            closeModal('editItemModal');
            alert('Item updated successfully!');
        }

        function updateDashboard() {
            const filtered = getFilteredInventory();
            const filteredDefective = getFilteredDefective();
            
            const today = new Date().toDateString();
            const filteredReturns = getFilteredReturns();
            const todayReturns = filteredReturns.filter(r => 
                new Date(r.date).toDateString() === today
            );
            
            document.getElementById('totalItems').textContent = filtered.length;
            document.getElementById('totalStock').textContent = filtered.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('lowStockItems').textContent = filtered.filter(item => item.quantity <= item.minStock).length;
            document.getElementById('totalValue').textContent = 'TZS ' + filtered.reduce((sum, item) => sum + (item.quantity * item.price), 0).toLocaleString();
            document.getElementById('defectiveCount').textContent = filteredDefective.length;
            document.getElementById('returnsToday').textContent = todayReturns.length;

            const activitiesDiv = document.getElementById('recentActivities');
            if (activities.length === 0) {
                activitiesDiv.innerHTML = '<p style="color: #666;">No recent activities</p>';
            } else {
                activitiesDiv.innerHTML = activities.slice(-10).reverse().map(activity => 
                    `<div style="padding: 10px; border-left: 3px solid #667eea; margin-bottom: 10px; background: #f8f9fa;">
                        <small style="color: #666;">${formatDate(activity.date)}</small><br>
                        ${activity.text}
                    </div>`
                ).join('');
            }
        }

        function addActivity(text) {
            activities.push({ text, date: new Date().toISOString() });
            if (activities.length > 100) activities = activities.slice(-100);
            saveData();
            updateDashboard();
        }

        function generateEODReport() {
            const reportDate = document.getElementById('reportDate').value;
            
            let filteredSales = getFilteredSales();
            let filteredDefective = getFilteredDefective();
            let filteredReturns = getFilteredReturns();
            
            if (reportDate) {
                const targetDate = new Date(reportDate).toDateString();
                filteredSales = filteredSales.filter(s => new Date(s.date).toDateString() === targetDate);
                filteredDefective = filteredDefective.filter(d => new Date(d.date).toDateString() === targetDate);
                filteredReturns = filteredReturns.filter(r => new Date(r.date).toDateString() === targetDate);
            }

            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalDiscount = filteredSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
            const totalItemsSold = filteredSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const grossRevenue = filteredSales.reduce((sum, sale) => sum + (sale.subtotal || sale.total), 0);

            const reportTitle = reportDate ? new Date(reportDate).toLocaleDateString() : 'All Time';
            const locationTitle = activeLocation || 'All Locations';

            const lowStockItems = getFilteredInventory().filter(item => item.quantity <= item.minStock);

            currentReportType = 'eod';
            currentReportData = {
                date: reportTitle,
                location: locationTitle,
                sales: filteredSales,
                defective: filteredDefective,
                returns: filteredReturns,
                totalSales: filteredSales.length,
                totalItemsSold: totalItemsSold,
                grossRevenue: grossRevenue,
                totalDiscount: totalDiscount,
                netRevenue: totalRevenue,
                lowStockItems: lowStockItems
            };

            const report = `
                <div style="padding: 30px; background: white;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;">
                        <h1 style="color: #667eea;">WAWLYN Limited</h1>
                        <h2>End of Day Report</h2>
                        <p><strong>Date:</strong> ${reportTitle}</p>
                        <p><strong>Location:</strong> ${locationTitle}</p>
                        <p><strong>Generated:</strong> ${formatDate(new Date().toISOString())}</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3>Sales Summary</h3>
                        <table style="width: 100%; border: 1px solid #ddd;">
                            <tr><td style="padding: 10px;"><strong>Total Sales:</strong></td><td style="padding: 10px;">${filteredSales.length}</td></tr>
                            <tr><td style="padding: 10px;"><strong>Items Sold:</strong></td><td style="padding: 10px;">${totalItemsSold}</td></tr>
                            <tr><td style="padding: 10px;"><strong>Gross Revenue:</strong></td><td style="padding: 10px;">TZS ${grossRevenue.toLocaleString()}</td></tr>
                            <tr><td style="padding: 10px;"><strong>Total Discounts:</strong></td><td style="padding: 10px; color: #28a745;">-TZS ${totalDiscount.toLocaleString()}</td></tr>
                            <tr style="background: #f8f9fa;"><td style="padding: 10px;"><strong>Net Revenue:</strong></td><td style="padding: 10px;"><strong>TZS ${totalRevenue.toLocaleString()}</strong></td></tr>
                            <tr><td style="padding: 10px;"><strong>Defective Items:</strong></td><td style="padding: 10px; color: #dc3545;">${filteredDefective.length}</td></tr>
                            <tr><td style="padding: 10px;"><strong>Returns/Exchanges:</strong></td><td style="padding: 10px; color: #17a2b8;">${filteredReturns.length}</td></tr>
                        </table>
                    </div>

                    ${filteredSales.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3>Detailed Sales</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Item</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Qty</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Price</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Subtotal</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Discount</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredSales.map(sale => {
                                    const discountText = sale.discountAmount > 0 
                                        ? `-TZS ${sale.discountAmount.toLocaleString()}`
                                        : '-';
                                    return `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${formatDate(sale.date)}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${sale.name} - ${sale.variant}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${sale.quantity}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">TZS ${sale.price.toLocaleString()}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">TZS ${(sale.subtotal || sale.total).toLocaleString()}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; color: #28a745;">${discountText}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>TZS ${sale.total.toLocaleString()}</strong></td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${sale.location}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    ${filteredDefective.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #dc3545;">‚ö†Ô∏è Defective Items</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #dc3545; color: white;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Item</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Quantity</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredDefective.map(def => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${formatDate(def.date)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${def.name} - ${def.variant}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${def.quantity}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${def.location}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${def.reason}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    ${filteredReturns.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #17a2b8;">üîÑ Returns & Exchanges</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #17a2b8; color: white;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Type</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Returned Item</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Qty</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Exchange Item</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Qty</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredReturns.map(ret => {
                                    const exchangeText = ret.type === 'exchange' && ret.exchangeItem
                                        ? `${ret.exchangeItem.name} - ${ret.exchangeItem.variant}`
                                        : '-';
                                    const exchangeQtyText = ret.type === 'exchange' ? ret.exchangeQuantity : '-';
                                    return `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${formatDate(ret.date)}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${ret.type.toUpperCase()}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${ret.returnedItemName} - ${ret.returnedItemVariant}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${ret.returnedQuantity}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${exchangeText}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${exchangeQtyText}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${ret.location}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <div style="margin-bottom: 30px;">
                        <h3>Low Stock Alerts</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #ffc107;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Item</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Current Stock</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Min Stock</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStockItems.map(item => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${item.name} - ${item.variant}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${item.quantity}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${item.minStock}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${item.location}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('reportContainer').innerHTML = report;
            document.getElementById('exportButtons').style.display = 'block';
        }

        function generateInventoryReport() {
            const filtered = getFilteredInventory();
            const locationTitle = activeLocation || 'All Locations';

            currentReportType = 'inventory';
            currentReportData = {
                location: locationTitle,
                items: filtered,
                totalValue: filtered.reduce((sum, item) => sum + (item.quantity * item.price), 0)
            };

            const report = `
                <div style="padding: 30px; background: white;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;">
                        <h1 style="color: #667eea;">WAWLYN Limited</h1>
                        <h2>Full Inventory Report</h2>
                        <p><strong>Location:</strong> ${locationTitle}</p>
                        <p><strong>Generated:</strong> ${formatDate(new Date().toISOString())}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Name</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Variant</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Quantity</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Min Stock</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Price</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Value</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Date Added</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(item => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${item.name}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${item.variant}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${item.quantity}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${item.minStock}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${item.location}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">TZS ${item.price.toLocaleString()}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">TZS ${(item.quantity * item.price).toLocaleString()}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${formatDate(item.dateAdded)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; text-align: right;">
                        <h3>Total Inventory Value: TZS ${filtered.reduce((sum, item) => sum + (item.quantity * item.price), 0).toLocaleString()}</h3>
                    </div>
                </div>
            `;

            document.getElementById('reportContainer').innerHTML = report;
            document.getElementById('exportButtons').style.display = 'block';
        }

        function generateSalesReport() {
            const reportDate = document.getElementById('reportDate').value;
            
            let filteredSales = getFilteredSales();
            
            if (reportDate) {
                filteredSales = filteredSales.filter(s => 
                    new Date(s.date).toDateString() === new Date(reportDate).toDateString()
                );
            }

            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const reportTitle = reportDate ? new Date(reportDate).toLocaleDateString() : 'All Time';
            const locationTitle = activeLocation || 'All Locations';

            currentReportType = 'sales';
            currentReportData = {
                period: reportTitle,
                location: locationTitle,
                sales: filteredSales,
                totalRevenue: totalRevenue
            };

            const report = `
                <div style="padding: 30px; background: white;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="logo.jpg" alt="WAWLYN Logo" style="max-width: 200px; margin-bottom: 20px;">
                        <h1 style="color: #667eea;">WAWLYN Limited</h1>
                        <h2>Sales Report</h2>
                        <p><strong>Period:</strong> ${reportTitle}</p>
                        <p><strong>Location:</strong> ${locationTitle}</p>
                        <p><strong>Generated:</strong> ${formatDateTime(new Date().toISOString())}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Date & Time</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Item</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Quantity</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSales.map(sale => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${formatDateTime(sale.date)}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${sale.name} - ${sale.variant}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${sale.quantity}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">TZS ${sale.total.toLocaleString()}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${sale.location}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; text-align: right;">
                        <h3>Total Revenue: TZS ${totalRevenue.toLocaleString()}</h3>
                    </div>
                </div>
            `;

            document.getElementById('reportContainer').innerHTML = report;
            document.getElementById('exportButtons').style.display = 'block';
        }

        function exportCurrentReport(format) {
            if (!currentReportType || !currentReportData) {
                alert('Please generate a report first!');
                return;
            }

            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `WAWLYN-${currentReportType}-report-${timestamp}`;

            if (format === 'pdf') {
                window.print();
            } else if (format === 'excel' || format === 'csv') {
                let csvContent = '';
                const delimiter = format === 'csv' ? ',' : '\t';

                if (currentReportType === 'eod') {
                    csvContent = `WAWLYN Limited - End of Day Report\n`;
                    csvContent += `Date: ${currentReportData.date}\n`;
                    csvContent += `Location: ${currentReportData.location}\n`;
                    csvContent += `Generated: ${formatDate(new Date().toISOString())}\n\n`;
                    
                    csvContent += `SALES SUMMARY\n`;
                    csvContent += `Total Sales${delimiter}${currentReportData.totalSales}\n`;
                    csvContent += `Items Sold${delimiter}${currentReportData.totalItemsSold}\n`;
                    csvContent += `Gross Revenue${delimiter}TZS ${currentReportData.grossRevenue.toLocaleString()}\n`;
                    csvContent += `Total Discounts${delimiter}TZS ${currentReportData.totalDiscount.toLocaleString()}\n`;
                    csvContent += `Net Revenue${delimiter}TZS ${currentReportData.netRevenue.toLocaleString()}\n`;
                    csvContent += `Defective Items${delimiter}${currentReportData.defective.length}\n`;
                    csvContent += `Returns/Exchanges${delimiter}${currentReportData.returns.length}\n\n`;
                    
                    if (currentReportData.sales.length > 0) {
                        csvContent += `DETAILED SALES\n`;
                        csvContent += `Date${delimiter}Item${delimiter}Quantity${delimiter}Price${delimiter}Subtotal${delimiter}Discount${delimiter}Total${delimiter}Location\n`;
                        currentReportData.sales.forEach(sale => {
                            const discountText = sale.discountAmount > 0 ? `TZS ${sale.discountAmount.toLocaleString()}` : '-';
                            csvContent += `${formatDate(sale.date)}${delimiter}${sale.name} - ${sale.variant}${delimiter}${sale.quantity}${delimiter}TZS ${sale.price.toLocaleString()}${delimiter}TZS ${(sale.subtotal || sale.total).toLocaleString()}${delimiter}${discountText}${delimiter}TZS ${sale.total.toLocaleString()}${delimiter}${sale.location}\n`;
                        });
                        csvContent += '\n';
                    }

                    if (currentReportData.defective.length > 0) {
                        csvContent += `DEFECTIVE ITEMS\n`;
                        csvContent += `Date${delimiter}Item${delimiter}Quantity${delimiter}Location${delimiter}Reason\n`;
                        currentReportData.defective.forEach(def => {
                            csvContent += `${formatDate(def.date)}${delimiter}${def.name} - ${def.variant}${delimiter}${def.quantity}${delimiter}${def.location}${delimiter}${def.reason}\n`;
                        });
                        csvContent += '\n';
                    }

                    if (currentReportData.returns.length > 0) {
                        csvContent += `RETURNS & EXCHANGES\n`;
                        csvContent += `Date${delimiter}Type${delimiter}Returned Item${delimiter}Qty${delimiter}Exchange Item${delimiter}Qty${delimiter}Location\n`;
                        currentReportData.returns.forEach(ret => {
                            const exchangeText = ret.type === 'exchange' && ret.exchangeItem ? `${ret.exchangeItem.name} - ${ret.exchangeItem.variant}` : '-';
                            const exchangeQtyText = ret.type === 'exchange' ? ret.exchangeQuantity : '-';
                            csvContent += `${formatDate(ret.date)}${delimiter}${ret.type.toUpperCase()}${delimiter}${ret.returnedItemName} - ${ret.returnedItemVariant}${delimiter}${ret.returnedQuantity}${delimiter}${exchangeText}${delimiter}${exchangeQtyText}${delimiter}${ret.location}\n`;
                        });
                        csvContent += '\n';
                    }
                    
                    csvContent += `LOW STOCK ALERTS\n`;
                    csvContent += `Item${delimiter}Current Stock${delimiter}Min Stock${delimiter}Location\n`;
                    currentReportData.lowStockItems.forEach(item => {
                        csvContent += `${item.name} - ${item.variant}${delimiter}${item.quantity}${delimiter}${item.minStock}${delimiter}${item.location}\n`;
                    });

                } else if (currentReportType === 'inventory') {
                    csvContent = `WAWLYN Limited - Full Inventory Report\n`;
                    csvContent += `Location: ${currentReportData.location}\n`;
                    csvContent += `Generated: ${formatDate(new Date().toISOString())}\n\n`;
                    
                    csvContent += `Name${delimiter}Variant${delimiter}Quantity${delimiter}Min Stock${delimiter}Location${delimiter}Price${delimiter}Value${delimiter}Date Added\n`;
                    currentReportData.items.forEach(item => {
                        csvContent += `${item.name}${delimiter}${item.variant}${delimiter}${item.quantity}${delimiter}${item.minStock}${delimiter}${item.location}${delimiter}TZS ${item.price.toLocaleString()}${delimiter}TZS ${(item.quantity * item.price).toLocaleString()}${delimiter}${formatDate(item.dateAdded)}\n`;
                    });
                    
                    csvContent += `\nTotal Inventory Value${delimiter}TZS ${currentReportData.totalValue.toLocaleString()}\n`;

                } else if (currentReportType === 'sales') {
                    csvContent = `WAWLYN Limited - Sales Report\n`;
                    csvContent += `Period: ${currentReportData.period}\n`;
                    csvContent += `Location: ${currentReportData.location}\n`;
                    csvContent += `Generated: ${formatDateTime(new Date().toISOString())}\n\n`;
                    
                    csvContent += `Date & Time${delimiter}Item${delimiter}Quantity${delimiter}Total${delimiter}Location\n`;
                    currentReportData.sales.forEach(sale => {
                        csvContent += `${formatDateTime(sale.date)}${delimiter}${sale.name} - ${sale.variant}${delimiter}${sale.quantity}${delimiter}TZS ${sale.total.toLocaleString()}${delimiter}${sale.location}\n`;
                    });
                    
                    csvContent += `\nTotal Revenue${delimiter}TZS ${currentReportData.totalRevenue.toLocaleString()}\n`;
                }

                const blob = new Blob([csvContent], { type: format === 'csv' ? 'text/csv;charset=utf-8;' : 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${fileName}.${format === 'csv' ? 'csv' : 'xls'}`;
                link.click();
                window.URL.revokeObjectURL(url);
                
                alert(`Report exported successfully as ${format.toUpperCase()}!`);
            }
        }

        function downloadTemplate() {
            const csv = 'Name,Variant,Quantity,Min Stock,Status,Location,Price\niPhone 14 Pro,128GB Black,10,5,In Stock,Main Store,45000\niPhone 14,64GB White,8,3,In Stock,Branch 1,35000\nSamsung Galaxy S23,256GB Gray,15,5,In Stock,Main Store,40000';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventory_template.csv';
            a.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                let imported = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const [name, variant, quantity, minStock, status, location, price] = line.split(',');
                    
                    if (name && variant && location) {
                        inventory.push({
                            id: Date.now() + i,
                            name: name.trim(),
                            variant: variant.trim(),
                            quantity: parseInt(quantity) || 0,
                            minStock: parseInt(minStock) || 0,
                            location: location.trim(),
                            price: parseFloat(price) || 0,
                            dateAdded: new Date().toISOString()
                        });
                        imported++;
                    }
                }

                saveData();
                addActivity(`Imported ${imported} items from CSV`);
                renderInventory();
                updateDashboard();
                updateSelects();
                alert(`Successfully imported ${imported} items!`);
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function exportData() {
            const data = {
                inventory: inventory,
                sales: sales,
                transfers: transfers,
                defectiveItems: defectiveItems,
                returns: returns,
                activities: activities,
                userCredentials: userCredentials,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WAWLYN-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }

        function clearAllData() {
            const confirmText = 'DELETE ALL DATA';
            const userInput = prompt(`‚ö†Ô∏è WARNING: This will delete ALL inventory, sales, and transfer records!\n\nType "${confirmText}" to confirm:`);
            
            if (userInput === confirmText) {
                inventory = [];
                sales = [];
                transfers = [];
                defectiveItems = [];
                returns = [];
                activities = [];
                saveData();
                renderInventory();
                renderSales();
                renderTransfers();
                renderDefective();
                renderReturns();
                updateDashboard();
                updateSelects();
                alert('All data has been cleared!');
                location.reload();
            } else if (userInput !== null) {
                alert('Deletion cancelled - text did not match.');
            }
        }

        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('transfers', JSON.stringify(transfers));
            localStorage.setItem('defectiveItems', JSON.stringify(defectiveItems));
            localStorage.setItem('returns', JSON.stringify(returns));
            localStorage.setItem('activities', JSON.stringify(activities));
            localStorage.setItem('userCredentials', JSON.stringify(userCredentials));
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
